<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/default-layout}">
  
<head>
<th:block layout:fragment="css">
	<link rel="stylesheet" href="/css/boardDetailQna.css">
</th:block>

<th:block layout:fragment="script">
   <script type="text/javascript" th:inline="javascript"> 
   
   $(function() {	   
	   
	   //글 삭제
       $("#btnDelete").on("click", (e) => {
    	   
           e.preventDefault();
           if (window.confirm("정말 삭제하시겠습니까?")) {
	           $.ajax({
	               url: '/board/board',
	               type: 'delete',
	               data: {
	                   boardId: $("#boardId").val()
	               },
	               success: (obj) => {
	                   console.log(obj);
	                   alert(obj.item.msg);
	                   location.href = `/board/qnaPage/1`;
	               },
	               error: (error) => {
	                   console.log(error);
	               }
	           });
           }
       });
	   
       // 댓글 등록
       $('#btnComment').on('click', function(e) {
    	    e.preventDefault();

    	    var commentContent = $('#commentContent').val();
    	    var boardId = $("#boardId").val();
    	    
    	 	// 댓글 내용이 비어있는지 확인
    	    if (!commentContent.trim()) {
    	        alert('댓글 내용을 입력해주세요.');
    	        return;
    	    }

    	    $.ajax({
    	        type: 'POST',
    	        url: '/comments-insert/' + boardId,
    	        contentType: 'application/json',
    	        data: JSON.stringify({content: commentContent,}),
    	        success: function(response) {
    	            if(response.success === "성공") {
    	            	// 댓글 작성에 성공하면 화면에 새로운 댓글을 추가.
    	                // 이를 위해 댓글을 담을 컨테이너를 준비하고, 해당 컨테이너에 새로 작성한 댓글의 내용을 추가.
    	                var newComment = $("<div>").addClass("comment-item");
    	                var commentAuthor = $("<div>").addClass("writer").text(response.data.writer); // 작성자 정보 추가
        				var commentContent = $("<div>").addClass("content").text(response.data.content);
        				var commentCreatedAt = $("<div>").addClass("createdAt").text(response.data.createdAt); 
    	                	                
    	                newComment.append(commentAuthor, commentContent,commentCreatedAt);
    	                
    	                $("#comments").append(newComment);  // 댓글 컨테이너에 새 댓글 요소 추가
    	                $("#commentContent").val('');  // 댓글 입력란 초기화
    	                console.log(newComment);
    	            } else {
    	                // 에러 메시지를 사용자에게 표시
    	                alert(response.message);
    	            }
    	        },
    	        error: function(jqXHR, textStatus, errorThrown) {
    	        	//validateAuthentication에 작성된 오류 메시지 사용자에게 표시 
    	            alert(jqXHR.responseJSON.message);
    	        	
    	         	// 현재 페이지 URL을 세션 스토리지에 저장
    	            if (window.location.pathname !== '/login') {
    	                sessionStorage.setItem('prevUrl', window.location.pathname);
    	            }
    	        	
    	         	// 로그인 페이지로 이동
    	            window.location.href = "/login";
    	        }
    	    });
    	});
   });
   
	 //기존 댓글 가져와서 표시
	   $(document).ready(function(){
	       var boardId = $("#boardId").val();
	
	       $.ajax({
	           type: 'GET',
	           url: '/comments/' + boardId,
	           success: function(response){
	        	   console.log(response);
	               if (response.success === "성공") {
	                   var comments = response.data;
	                   comments.forEach(function(comment) {
	                	   // Check if comment content is undefined
	                       if (comment.content === undefined) {
	                           console.log("Undefined comment content:", comment);
	                       }
	                	   
	                       var newComment = $("<div>").addClass("comment-item");
	                       var commentAuthor = $("<div>").addClass("writer").text(comment.writer); // 작성자 정보를 화면에 표시
	                       var commentContent = $("<div>").addClass("content").text(comment.content); 
	                       var commnetCreatedAt = $("<div>").addClass("createdAt").text(comment.createdAt); 
	                       
	                       newComment.append(commentAuthor, commentContent, comment.createdAt);
	                	   
	                       $("#comments").append(newComment);
	                       
	                       console.log("New comment:", newComment);
	                   });
	                   
	                   
	                   $("#commentContent").val('');
	                   // 댓글 등록 후 콘솔에 정보 출력
	                   console.log("댓글 등록 성공");
	                   console.log("댓글 내용:", comments);
	               } else {
	                   alert(response.message);
	               }
	           },
	           error: function(jqXHR, textStatus, errorThrown) {
	               alert("댓글 작성에 실패하였습니다. 다시 시도해주세요.");
	           }
	       });
	   });

   
   </script>
</th:block>
    
</head>

<body> 
<th:block layout:fragment="content">  
	
	
<form id="updateForm">
   <div class="container py-5">
	 <input type="hidden" id="boardId" name="boardId" th:value="${board.boardId}">
      <section id="postSection">
        <div id="postContainer">
          <div id="boardTitle" name="boardTitle" th:text="${board.boardTitle}"></div>
          <div id="postInfo">
            <span id="postWriter" th:text="'작성자: ' + ${board.boardWriter}" ></span>
            <span id="postDate" th:text="'작성일: ' + ${#strings.substring(board.boardRegdate, 0, 10) }"></span>
            <span id="postViews" th:text="'조회수: ' + ${board.boardCnt}"></span>
          </div>
          <div id="boardContent" name="boardContent" th:text="${board.boardContent}"></div>
          <div id="fileSection">
            <h4>첨부 파일</h4>
            <ul id="fileList">
                <!-- 첨부파일이 있으면 이름을 표시하고 다운로드 링크를 제공 -->
	            <li th:each="fle : ${board.fileList}">
	            	<img th:src="@{/board/attach/{filename}(filename=${fle.filePath})}" width="50" height="50"/>
	                <span th:text="${fle.fileName}"></span>              
	            </li>
            </ul>
          </div>
          
          <!-- 댓글 리스트 -->
		  <div id="comments">
		      <h4>댓글 목록</h4>
			  <!-- 기존 댓글들은 여기에 표시 -->     
			  <div class="comment-item" th:each="comment : ${comments}">
	            <span th:text="${comment.writer}"></span>
		        <span th:text="${comment.content}"></span>
				<span id="comment-date" th:text="${#strings.substring(comment.createdAte, 0, 10) }"></span>
            	<a type="button" id="btnCommentDelete">삭제</a>

			  </div>
		   </div>
          
          <!-- 댓글 입력 부분 -->
		  <div id="commentSection">
		   <h4>댓글 작성</h4>
		     <textarea id="commentContent" name="commentContent" placeholder="댓글을 입력해주세요."></textarea>
		     <a type="button" id="btnComment">댓글 등록</a>
		  </div>
		  
          <div id="postActions">
            <!-- 로그인한 사용자만 보고, 게시글 작성자와 로그인 사용자가 같을 경우 보여주는 내용 -->
          	<div th:if="${username != null and board.boardWriter == username}">
            	<a th:href="@{/board/modify-board-view/{boardId}(boardId=${board.boardId})}" type="submit" id="btnUpdate">글 수정</a>
          	</div>
          	
            <a href="/board/qnaPage/1" type="button" id="btnList">글 목록</a>
            
            <!-- 로그인한 사용자만 보고, 게시글 작성자와 로그인 사용자가 같을 경우 보여주는 내용 -->
            <div th:if="${username != null and board.boardWriter == username}">
            	<a type="button" id="btnDelete">글 삭제</a>
            </div>
          </div>
        </div>
      </section>
    </div>
</form>
</th:block>
</body> 
</html>
