<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/default-layout}">
  
<head>
<th:block layout:fragment="css">
	<link rel="stylesheet" href="/css/boardDetailQna.css">
</th:block>

<th:block layout:fragment="script">
   <script type="text/javascript" th:inline="javascript"> 
   
   $(function() {
	   // 삭제할 항목을 저장할 배열
	   let toDelete = [];
	   // 추가할 파일 저장할 배열 
	   let toAdd = [];
	   
	   let boardId = $("#boardId").val();

	   // 파일 추가 버튼 눌렀을 때
	   $("#btnAddFile").click(function (){
		   console.log("dd");
	       // 파일 선택 창 열기
	       $("#fileInput").click();
	   });

	   // 사용자가 파일을 선택하면 미리보기 이미지를 보여주는 기능
	   $("#fileInput").change(function() {
			// 선택된 파일 목록에 추가
			// this.files는 사용자가 방금 파일 선택 창에서 선택한 파일들의 목록
		    let newFiles = Array.from(this.files);
			//기존 toAdd 배열에 새롭게 추가된 newFiles 배열을 합치는 거
		    toAdd = toAdd.concat(newFiles);
		    // 새로 추가된 파일만 리스트에 추가
		    //forEach 루프는 newFiles라는 배열의 각 원소에 대해 주어진 함수를 실행
		    //function(file, index) { ... }는 forEach에 전달되는 콜백 함수
		    //newFiles 배열의 각 원소에 대해 한 번씩 호출
		    //file 매개변수는 현재 처리하고 있는 배열의 원소, index 매개변수는 현재 처리하고 있는 원소의 인덱스.
		    newFiles.forEach(function(file, index) {
		    	//FileReader는 웹 애플리케이션에서 파일을 비동기적으로 읽기 위한 객체
		        let reader = new FileReader();
		    	//FileReader 객체의 onload 이벤트 핸들러
		    	//FileReader가 파일 읽기를 완료하면 실행되는 함수
		        reader.onload = function(e) {
		            // FileReader 결과 사용하여 이미지를 미리 보여준다
		            //#fileList 요소에 새로운 <li> 요소를 추가
		            //e.target.result에는 읽은 파일의 데이터 URL이 담겨있다.
		            //이 데이터 URL을 이미지의 src 속성으로 사용하여 미리보기 이미지 생성
		            $("#fileList").append('<li><input type="checkbox" class="fileCheckbox" /><input type="hidden" class="fileId" value="new-' + index + '"><img src="' + e.target.result + '" width="50" height="50" /><span>' + file.name + '</span></li>');
		        }
		        //FileReader.readAsDataURL(file) 메소드는 파일을 base64 인코딩된 문자열 데이터 URL로 읽음. 
		        //이 데이터 URL은 <img> 태그의 src 속성으로 사용될 수 있어, 이미지 파일을 브라우저에서 미리 보여주는 데 유용
		        reader.readAsDataURL(file);
		    });
	   });

	   // 파일 삭제 버튼 눌렀을 때 
	   $("#btnDeleteFile").click(function() {
			// 체크된 체크박스가 있는지 확인
		    if ($(".fileCheckbox:checked").length == 0) {
		        // 체크된 체크박스가 없으면 즉시 반환하여 경고 메시지를 표시하지 않음
		        return;
		    }
		
		    if (window.confirm("정말 삭제하시겠습니까?")) {
		        // 화면에 표시된 모든 파일 체크박스를 순회
		        $(".fileCheckbox").each(function() {
		        	//현재 순회 중인 체크박스가 체크되어 있는지 확인
		            if ($(this).is(":checked")) {
		                //현재 순회 중인 체크박스와 동일한 부모를 가지는 첫 번째 ".fileId" 요소의 값을 가져옴
		                //각 체크박스에 연결된 파일의 ID
		                const fileId = $(this).siblings(".fileId").val();
		                //"new-"로 시작하는 파일 ID는 새로 추가
		                if (fileId.startsWith("new-")) {
		                    //fileId.substring(4)는 "new-" 문자열을 제거하고, parseInt는 문자열을 숫자로 변환
		                    //이렇게 얻은 숫자는 toAdd 배열에서 파일의 위치를 나타냄
		                    const index = parseInt(fileId.substring(4));
		                    //index 값이 toAdd 배열의 범위 내에 있는지 확인
		                    //범위 내에 있다면, 해당 위치의 요소를 toAdd 배열에서 삭제
		                    if (index >= 0 && index < toAdd.length) {
		                        toAdd.splice(index, 1);
		                        // 삭제 후에 toAdd 배열의 인덱스가 변경되므로, 
		                        //삭제된 요소 이후의 모든 "new-"로 시작하는 파일 ID를 업데이트
		                        //삭제된 요소 이후의 모든 파일 ID에서 인덱스를 1씩 감소
		                        $(".fileId").each(function() {
		                            const oldFileId = $(this).val();
		                            if (oldFileId.startsWith("new-")) {
		                                const oldIndex = parseInt(oldFileId.substring(4));
		                                if (oldIndex > index) {
		                                    $(this).val("new-" + (oldIndex - 1));
		                                }
		                            }
		                        });
		                    }
		                } else {
		                    // 기존 파일이면 toDelete에 추가
		                    if (!toDelete.includes(fileId)) {
		                        toDelete.push(fileId);
		                    }
		                }
		                // 파일 항목 감추기
		                $(this).parent().hide();
		            }
		        });
		    }
		});


	   //수정 완료 버튼 
	   $("#btnUpdate").click(function() {
	       if (window.confirm("변경사항을 저장하시겠습니까?")) {	
	           // FormData 객체 생성
	           let formData = new FormData();
	           //FormData 객체에 JSON 데이터 추가
	           //FormData는 HTML <form> 요소의 데이터를 쉽게 구성하고 전송하기 위한 객체
	           //new Blob([JSON.stringify({...})], { type: "application/json" })
	           //        -> JSON 객체를 문자열로 변환한 후 Blob 객체로 래핑
	           //Blob은 바이너리 데이터를 나타내는 객체로, 일반적으로 파일 업로드 시 사용
	           //JSON.stringify({...})는 JavaScript 객체를 JSON 문자열로 변환하는 함수
	           //({...})안에 들어가는 값은 객체 리터럴 내부에 들어가는 실제 데이터
	           //		-> HTML 요소에서 해당하는 값들을 가져온 것
	           //=> JSON 형식의 데이터를 FormData에 추가하여 서버로 전송하기 위한 작업
	           formData.append('board', new Blob([JSON.stringify({
	        	   //.val()를 사용하면 선택된 HTML 요소의 현재 값을 가져옴. value값
	               boardId: $("#boardId").val(),
	               boardTitle: $("#boardTitle").val(),
	               boardContent: $("#boardContent").val(),
	               //toDelete라는 변수의 값을 할당
	               //toDelete는 삭제할 첨부파일의 id들을 저장하는 배열
	               attachDelete: toDelete
	           })], {
	               type: "application/json"
	           }));

	           // toAdd에 있는 모든 파일을 추가
	           toAdd.forEach(file => {
	               formData.append('files', file);
	           });

	           $.ajax({
	               url: "/board/board-modify",
	               type: 'post',
	               data: formData, 
	               contentType: false,
	               processData: false,
	               success: (obj) => {
	                   console.log(obj);
	                   alert(obj.item.msg);
	                   location.href = `/board/board/${boardId}`;
	               },
	               error: (error) => {
	                   console.log(error);
	               }
	           });
	       }
	   });

	   //수정 취소 버튼
	   $("#btnList").click(function() {
	       if (window.confirm("변경사항을 취소하시겠습니까?")) {
	           toDelete = []; // 삭제 배열 초기화
	           toAdd = []; // 추가 배열 초기화
	           $("#fileList li").show(); // 모든 파일 항목 다시 표시
	           location.href = `/board/board/${boardId}`;
	       }
	   });

	   //글 삭제 버튼 
	   $("#btnDelete").on("click", (e) => {
	       e.preventDefault();
	       if (window.confirm("정말 삭제하시겠습니까?")) {
	           $.ajax({
	               url: '/board/board',
	               type: 'delete',
	               data: {
	                   boardId: $("#boardId").val()
	               },
	               success: (obj) => {
	                   console.log(obj);
	                   alert(obj.item.msg);
	                   location.href = `/board/qnaPage/1`;
	               },
	               error: (error) => {
	                   console.log(error);
	               }
	           });
	       }
	   });

   }); 
   </script>
</th:block>
    
</head>

<body> 
<th:block layout:fragment="content">  
		
<form id="updateForm" action="/board/board-modify" method="post" enctype="multipart/form-data">
   <div class="container py-5">
	 <input type="hidden" id="boardId" name="boardId" th:value="${board.boardId}">
      <section id="postSection">
        <div id="postContainer">
          <input id="boardTitle" name="boardTitle" th:value="${board.boardTitle}">
          <div id="postInfo">
            <span id="postWriter" th:text="'작성자: ' + ${board.boardWriter}"></span>
            <span id="postDate" th:text="'작성일: ' + ${#strings.substring(board.boardRegdate, 0, 10) }"></span>
            <span id="postViews" th:text="'조회수: ' + ${board.boardCnt}"></span>
          </div>
          <input id="boardContent" name="boardContent" th:value="${board.boardContent}">
          <div id="fileSection">
            <h4 style="display: inline">첨부 파일</h4>
            <!-- 첨부 파일 추가 및 삭제 버튼 추가 -->
            <button id="btnAddFile" type="button" style="float: right;">파일 추가</button>
		    <button id="btnDeleteFile" type="button" style="float: right; margin-right:5px;">파일 삭제</button> 
            <input type="file" id="fileInput" name="fileInput" style="display: none" multiple>
            <ul id="fileList" name="fileList" style="min-height:50px;">
                <!-- 첨부파일이 있으면 미리보기 제공 -->
	            <li th:each="fle : ${board.fileList}">
	            	<input type="checkbox" class="fileCheckbox" />
	            	<input type="hidden" class="fileId" th:value="${fle.id}">
	            	<img th:src="@{/board/attach/{filename}(filename=${fle.filePath})}" width="50" height="50" />
	                <span th:text="${fle.fileName}"></span>  
	                <a type="button" id="btnCommentDelete">삭제</a>       
	            </li>
            </ul>
          </div>       
          <div id="postActions">           
            <a type="button" id="btnDelete">글 삭제</a>
            <a type="button" id="btnUpdate">수정 완료</a>
            <a type="button" id="btnList">수정 취소</a>
          </div>
        </div>
      </section>
    </div>
</form>

</th:block>
</body> 
</html>
